(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const u of r)if(u.type==="childList")for(const y of u.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&i(y)}).observe(document,{childList:!0,subtree:!0});function s(r){const u={};return r.integrity&&(u.integrity=r.integrity),r.referrerPolicy&&(u.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?u.credentials="include":r.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function i(r){if(r.ep)return;r.ep=!0;const u=s(r);fetch(r.href,u)}})();const Pe="./";async function ze(){const n=new URL("data/manifest.json",Pe).toString(),e=await fetch(n,{cache:"reload"});if(!e.ok)throw console.error("Failed to load manifest",e.status,e.statusText),new Error(`tickers: ${e.status}`);const s=await e.json();return Array.isArray(s)?s:s&&Array.isArray(s.symbols)?s.symbols:[]}async function et(n,e){const s=new URL(`data/history/${encodeURIComponent(n)}.json`,Pe).toString(),i=await fetch(s,{cache:"reload"});if(!i.ok)return console.error("History fetch failed",n,i.status,i.statusText),[];const r=await i.json();return Array.isArray(r)?r:(console.error("Unexpected history payload",n,r),[])}const he=(n,e)=>e.some(s=>n instanceof s);let Be,Me;function tt(){return Be||(Be=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function nt(){return Me||(Me=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ge=new WeakMap,pe=new WeakMap,ae=new WeakMap;function at(n){const e=new Promise((s,i)=>{const r=()=>{n.removeEventListener("success",u),n.removeEventListener("error",y)},u=()=>{s(_(n.result)),r()},y=()=>{i(n.error),r()};n.addEventListener("success",u),n.addEventListener("error",y)});return ae.set(e,n),e}function ot(n){if(ge.has(n))return;const e=new Promise((s,i)=>{const r=()=>{n.removeEventListener("complete",u),n.removeEventListener("error",y),n.removeEventListener("abort",y)},u=()=>{s(),r()},y=()=>{i(n.error||new DOMException("AbortError","AbortError")),r()};n.addEventListener("complete",u),n.addEventListener("error",y),n.addEventListener("abort",y)});ge.set(n,e)}let we={get(n,e,s){if(n instanceof IDBTransaction){if(e==="done")return ge.get(n);if(e==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return _(n[e])},set(n,e,s){return n[e]=s,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function Ae(n){we=n(we)}function st(n){return nt().includes(n)?function(...e){return n.apply(be(this),e),_(this.request)}:function(...e){return _(n.apply(be(this),e))}}function rt(n){return typeof n=="function"?st(n):(n instanceof IDBTransaction&&ot(n),he(n,tt())?new Proxy(n,we):n)}function _(n){if(n instanceof IDBRequest)return at(n);if(pe.has(n))return pe.get(n);const e=rt(n);return e!==n&&(pe.set(n,e),ae.set(e,n)),e}const be=n=>ae.get(n);function it(n,e,{blocked:s,upgrade:i,blocking:r,terminated:u}={}){const y=indexedDB.open(n,e),M=_(y);return i&&y.addEventListener("upgradeneeded",D=>{i(_(y.result),D.oldVersion,D.newVersion,_(y.transaction),D)}),s&&y.addEventListener("blocked",D=>s(D.oldVersion,D.newVersion,D)),M.then(D=>{u&&D.addEventListener("close",()=>u()),r&&D.addEventListener("versionchange",$=>r($.oldVersion,$.newVersion,$))}).catch(()=>{}),M}const ct=["get","getKey","getAll","getAllKeys","count"],lt=["put","add","delete","clear"],ye=new Map;function $e(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(ye.get(e))return ye.get(e);const s=e.replace(/FromIndex$/,""),i=e!==s,r=lt.includes(s);if(!(s in(i?IDBIndex:IDBObjectStore).prototype)||!(r||ct.includes(s)))return;const u=async function(y,...M){const D=this.transaction(y,r?"readwrite":"readonly");let $=D.store;return i&&($=$.index(M.shift())),(await Promise.all([$[s](...M),r&&D.done]))[0]};return ye.set(e,u),u}Ae(n=>({...n,get:(e,s,i)=>$e(e,s)||n.get(e,s,i),has:(e,s)=>!!$e(e,s)||n.has(e,s)}));const ut=["continue","continuePrimaryKey","advance"],Ie={},ve=new WeakMap,Oe=new WeakMap,dt={get(n,e){if(!ut.includes(e))return n[e];let s=Ie[e];return s||(s=Ie[e]=function(...i){ve.set(this,Oe.get(this)[e](...i))}),s}};async function*mt(...n){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...n)),!e)return;e=e;const s=new Proxy(e,dt);for(Oe.set(s,e),ae.set(s,be(e));e;)yield s,e=await(ve.get(s)||e.continue()),ve.delete(s)}function Te(n,e){return e===Symbol.asyncIterator&&he(n,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&he(n,[IDBIndex,IDBObjectStore])}Ae(n=>({...n,get(e,s,i){return Te(e,s)?mt:n.get(e,s,i)},has(e,s){return Te(e,s)||n.has(e,s)}}));const Ue="2000-01-03";async function z(){return it("time-machine",2,{upgrade(n){if(n.objectStoreNames.contains("system")||n.createObjectStore("system"),n.objectStoreNames.contains("holdings")||n.createObjectStore("holdings",{keyPath:"symbol"}),n.objectStoreNames.contains("transactions")||n.createObjectStore("transactions",{keyPath:"id",autoIncrement:!0}),!n.objectStoreNames.contains("prices")){const e=n.createObjectStore("prices",{keyPath:"key"});e.createIndex("bySymbol","symbol",{unique:!1}),e.createIndex("bySymbolDate",["symbol","date"],{unique:!1})}n.objectStoreNames.contains("tickers")||n.createObjectStore("tickers",{keyPath:"symbol"})}})}async function ke(){const n=await z(),e=await n.get("system","system");if(!e){const i={id:"system",currentDate:Ue,timeOfDay:"open",cash:1e4};await n.put("system",i,"system");const r=[{date:i.currentDate,time:i.timeOfDay,value:i.cash}];return await n.put("system",r,"history"),i}if(!await n.get("system","history")){const i=[{date:e.currentDate,time:e.timeOfDay,value:e.cash}];await n.put("system",i,"history")}return e}async function pt(n,e){const i=(await z()).transaction("prices","readwrite"),r=i.objectStore("prices");for(const u of e){const y={key:`${n}:${u.date}`,symbol:n,date:u.date,price:u.price};await r.put(y)}await i.done}async function yt(n){const s=(await z()).transaction("prices").store.index("bySymbol"),i=[];let r=await s.openCursor(n);for(;r;)i.push(r.value),r=await r.continue();return i.sort((u,y)=>u.date.localeCompare(y.date))}async function ft(n){const s=(await z()).transaction("system","readwrite"),i=s.store,r=await i.get("history")??[];r.length||r.push({date:Ue,time:"open",value:n.value});const u=r[r.length-1];return u&&u.date===n.date&&u.time===n.time?r[r.length-1]=n:r.push(n),await i.put(r,"history"),await s.done,r}const te=1e-4,ne=.01,Q={"BTC-USD":{name:"Bitcoin",invention:"2009-01-03"},"ETH-USD":{name:"Ethereum",invention:"2015-07-30"}},Fe="2000-01-03",k="2025-10-01";function q(n){return new Date(`${n}T00:00:00Z`)}function De(n){return n>k?k:n}function B(n){return n.toLocaleString(void 0,{style:"currency",currency:"USD"})}function Ne(n){return`${n>=0?"+":"-"}${B(Math.abs(n))}`}function je(n){return n.toLocaleString(void 0,{minimumFractionDigits:0,maximumFractionDigits:4})}function H(n){const e=q(n).getUTCDay();return e===0||e===6}function fe(n,e){const s=q(n);return s.setUTCDate(s.getUTCDate()+e),De(s.toISOString().slice(0,10))}function Le(n,e){const s=q(n);return s.setUTCMonth(s.getUTCMonth()+e),De(s.toISOString().slice(0,10))}function ht(n){return q(n).toLocaleDateString(void 0,{weekday:"long",timeZone:"UTC"})}const R=new Map,G=new Map;async function X(n){if(R.has(n))return R.get(n);if(G.has(n))return G.get(n);const e=(async()=>{const s=await yt(n);if(s.length){const r=s.map(u=>({date:u.date,price:u.price})).sort((u,y)=>u.date.localeCompare(y.date));return R.set(n,r),G.delete(n),r}const i=await et(n);return i.length?(R.set(n,i),await pt(n,i)):R.set(n,[]),G.delete(n),R.get(n)})();return G.set(n,e),e}async function V(n,e){const s=await X(n);let i=0,r=s.length-1,u;for(;i<=r;){const y=Math.floor((i+r)/2);s[y].date<=e?(u=s[y],i=y+1):r=y-1}return u==null?void 0:u.price}async function oe(n,e,s=10){const i=await X(n);let r=0,u=i.length-1,y=-1;for(;r<=u;){const D=Math.floor((r+u)/2);i[D].date<=e?(y=D,r=D+1):u=D-1}if(y<=0)return;const M=i[y].date;for(let D=y-1;D>=0&&y-D<=s;D--)if(i[D].date<M)return i[D].price}async function gt(n,e){const s=await V(n.symbol,e),i=s!==void 0?await oe(n.symbol,e):void 0,r=s!==void 0?n.shares*s:0,u=n.avgCost*n.shares,y=s!==void 0?r-u:0,M=s!==void 0&&u>0?y/u*100:void 0,D=s!==void 0&&i!==void 0?s-i:void 0,$=D!==void 0&&i?D/i*100:void 0;return{symbol:n.symbol,shares:n.shares,avgCost:n.avgCost,price:s,change:D,percentChange:$,positionValue:r,gain:y,gainPercent:M}}async function wt(n,e,s,i,r,u){const y=await V(n,s),M=y!==void 0?await oe(n,s):void 0,D=y!==void 0&&M!==void 0?y-M:void 0,$=D!==void 0&&M?D/M*100:void 0;return{symbol:n,name:e,price:y,change:D,percentChange:$,holdingShares:i,canTrade:r,showClosedNote:u}}async function bt(n,e,s){const i=await V(n,s),r=i!==void 0?await oe(n,s):void 0,u=i!==void 0&&r!==void 0?i-r:void 0,y=u!==void 0&&r?u/r*100:void 0;return{symbol:n,name:e,price:i,change:u,percentChange:y}}let T=0;async function vt(){await ke();const n=await z(),e={date:document.getElementById("infoDate"),day:document.getElementById("infoDay"),time:document.getElementById("infoTime"),cash:document.getElementById("infoCash"),pv:document.getElementById("infoPV"),searchInput:document.getElementById("searchInput"),suggestions:document.getElementById("suggestions"),searchForm:document.getElementById("searchForm"),weekendNote:document.getElementById("weekendNote"),loadingMessage:document.getElementById("loadingMessage"),pinnedSection:document.getElementById("pinnedSection"),pinnedGrid:document.getElementById("pinnedGrid"),portfolioSection:document.getElementById("portfolioSection"),holdingsBody:document.getElementById("holdingsBody"),txSection:document.getElementById("transactionsSection"),txBody:document.getElementById("txBody"),cryptoSection:document.getElementById("cryptoSection"),cryptoGrid:document.getElementById("cryptoGrid"),buySection:document.getElementById("buySection"),chartCanvas:document.getElementById("portfolioChart"),resetBtn:document.getElementById("resetBtn"),jumpWeek:document.getElementById("jumpWeek"),jumpMonth:document.getElementById("jumpMonth"),jumpYear:document.getElementById("jumpYear"),nextBtn:document.getElementById("nextBtn"),skipWeekend:document.getElementById("skipWeekend"),jumpForm:document.getElementById("jumpForm"),jumpYearSel:document.getElementById("jumpYearSel"),jumpMonthSel:document.getElementById("jumpMonthSel"),jumpDaySel:document.getElementById("jumpDaySel"),jumpError:document.getElementById("jumpError"),sellModal:document.getElementById("sellModal"),sellClose:document.getElementById("sellClose"),sellForm:document.getElementById("sellForm"),sellSymbol:document.getElementById("sellSymbol"),sellSharesMax:document.getElementById("sellSharesMax")},s=()=>{e.jumpError.textContent="You have reached the end of available data (Oct 1, 2025).",e.jumpError.style.display="block"},i=()=>{e.jumpError&&(e.jumpError.style.display="none")};async function r(){return await n.get("system","system")||{id:"system",currentDate:Fe,timeOfDay:"open",cash:1e4}}async function u(t){await n.put("system",t,"system")}async function y(){return await n.getAll("holdings")}async function M(t){await n.put("holdings",t)}async function D(t){await n.delete("holdings",t)}async function $(t){await n.add("transactions",t)}async function He(t=20){return(await n.getAll("transactions")).sort((d,l)=>d.date>l.date?-1:1).slice(0,t)}async function se(){return await n.get("system","pinned")||[]}async function Se(t){await n.put("system",t,"pinned")}let re=null,Z=[];async function Ye(){try{Z=await ze();const t=n.transaction("tickers","readwrite");for(const a of Z)await t.store.put(a);await t.done}catch(t){console.warn("Failed to load tickers",t)}}await Ye(),await Promise.all(Object.keys(Q).map(t=>X(t)));function We(t){e.jumpYearSel.innerHTML="",e.jumpMonthSel.innerHTML="",e.jumpDaySel.innerHTML="";const a=parseInt(t.slice(0,4),10),d=parseInt(t.slice(5,7),10),l=parseInt(t.slice(8,10),10);for(let c=2e3;c<=2025;c++){const o=document.createElement("option");o.value=String(c),o.textContent=String(c),c===a&&(o.selected=!0),e.jumpYearSel.appendChild(o)}for(let c=1;c<=12;c++){const o=document.createElement("option");o.value=String(c),o.textContent=new Date(2e3,c-1).toLocaleString(void 0,{month:"short"}),c===d&&(o.selected=!0),e.jumpMonthSel.appendChild(o)}for(let c=1;c<=31;c++){const o=document.createElement("option");o.value=String(c),o.textContent=String(c),c===l&&(o.selected=!0),e.jumpDaySel.appendChild(o)}}function Re(t){const a=t.length,d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(a<=12)return t.map(b=>{const g=new Date(`${b}T00:00:00Z`);return Number.isNaN(g.getTime())?b:`${d[g.getUTCMonth()]} ${g.getUTCFullYear()}`});if(a<=24)return t.map((b,g)=>{const h=new Date(`${b}T00:00:00Z`);return Number.isNaN(h.getTime())?b:g%2===0||h.getUTCMonth()===0?`${d[h.getUTCMonth()]} ${h.getUTCFullYear()}`:""});if(a<=60)return t.map((b,g)=>{const h=new Date(`${b}T00:00:00Z`);return Number.isNaN(h.getTime())?b:g%4===0||h.getUTCMonth()===0?`${d[h.getUTCMonth()]} ${h.getUTCFullYear()}`:""});const l=new Date(`${t[0]}T00:00:00Z`),c=new Date(`${t[t.length-1]}T00:00:00Z`),o=l.getUTCFullYear(),p=c.getUTCFullYear(),m=Math.max(1,p-o+1);let f=1,v=!1;return m<=7?(v=!0,f=1):m<=12?(v=!1,f=1):m<=18?(v=!1,f=2):(v=!1,f=3),t.map(b=>{const g=new Date(`${b}T00:00:00Z`);if(Number.isNaN(g.getTime()))return b;const h=g.getUTCFullYear(),w=g.getUTCMonth();return v?w===0||w===6?`${d[w]} ${h}`:"":w===0&&(h-o)%f===0?`${d[w]} ${h}`:""})}function Ve(t){return t.length?t.map(a=>{const d=new Date(`${a.date}T00:00:00Z`);return Number.isNaN(d.getTime())?null:{date:d.toISOString().slice(0,10),value:a.value}}).filter(a=>!!a).sort((a,d)=>a.date.localeCompare(d.date)):[]}function ie(t){return t.slice(0,7)}function _e(t,a){return new Date(Date.UTC(t,a,0)).toISOString().slice(0,10)}function Ge(t,a){let d=t,l=a+1;return l>12&&(l=1,d+=1),[d,l]}async function qe(t,a,d,l){const c=new Map;let o=1e4;if(t&&t.length){const C=[...t].sort((x,P)=>x.date===P.date?x.time.localeCompare(P.time):x.date.localeCompare(P.date))[0];C&&typeof C.value=="number"&&(o=C.value);for(const x of t){const P=ie(x.date),j=c.get(P);(!j||x.date>j.date)&&c.set(P,{date:x.date,value:x.value})}}const p=await n.getAll("transactions");p.sort((C,x)=>C.date===x.date?C.time.localeCompare(x.time):C.date.localeCompare(x.date));const m=Array.from(new Set(p.map(C=>C.symbol)));await Promise.all(m.map(C=>X(C)));const f=Array.from(new Set([...c.keys()])).sort(),v=f.length?f[0]:ie(Fe),b=ie(a);let g=parseInt(v.slice(0,4),10),h=parseInt(v.slice(5,7),10),w=0;const S=new Map;let E=o;const I=[];let L=`${g.toString().padStart(4,"0")}-${h.toString().padStart(2,"0")}`;for(;L<=b;){const C=_e(g,h),x=L===b&&C>a?a:C;for(;w<p.length&&p[w].date<=x;){const j=p[w],U=j.symbol,K=Number(j.shares)||0,J=Number(j.total)||0;S.has(U)||S.set(U,0),j.type==="BUY"?(S.set(U,+(S.get(U)+K).toFixed(4)),E=+(E-J).toFixed(2)):j.type==="SELL"&&(S.set(U,Math.max(0,+(S.get(U)-K).toFixed(4))),E=+(E+J).toFixed(2)),w++}const P=c.get(L);if(P)I.push({date:P.date,value:P.value});else{let j=0;for(const[U,K]of S.entries()){if(K<=0)continue;const J=await V(U,x);J!==void 0&&(j+=K*J)}I.push({date:x,value:+(E+j).toFixed(2)})}[g,h]=Ge(g,h),L=`${g.toString().padStart(4,"0")}-${h.toString().padStart(2,"0")}`}return I.sort((C,x)=>C.date.localeCompare(x.date)),I}let ce;async function Ze(t){const a=e.chartCanvas.getContext("2d");if(!a)return;ce&&ce.destroy();const d=Re(t.map(l=>l.date));ce=new Chart(a,{type:"line",data:{labels:d,datasets:[{label:"Monthly Portfolio Value",data:t.map(l=>l.value),borderColor:"#28a745",backgroundColor:"rgba(40, 167, 69, 0.1)",tension:.1,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"},tooltip:{callbacks:{title:l=>{if(!l.length)return"";const c=l[0].dataIndex,o=q(t[c].date);return Number.isNaN(o.getTime())?t[c].date:o.toLocaleDateString(void 0,{year:"numeric",month:"long"})},label:l=>"$"+Number(l.parsed.y).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}}},scales:{x:{ticks:{maxRotation:0,autoSkip:!1}},y:{beginAtZero:!1,ticks:{callback:l=>"$"+Number(l).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}}}}})}function Y(t){for(;t.firstChild;)t.removeChild(t.firstChild)}async function Ke(t,a,d,l){if(e.pinnedSection.style.display=t.length?"":"none",!t.length){Y(e.pinnedGrid);return}const c=await Promise.all(t.map(async o=>{const p=Z.find(h=>h.symbol===o),m=(p==null?void 0:p.name)||o,f=d.get(o),v=H(a)&&!W(o),b=!v;return await wt(o,m,a,f?f.shares:0,b,v)}));if(l===T){Y(e.pinnedGrid);for(const o of c){const p=document.createElement("div");p.className="pinned-card";const m=document.createElement("div");m.className="stock-buy-details pinned-stock-details";const f=document.createElement("div");f.className="pinned-header";const v=document.createElement("h3");v.textContent=`${o.symbol} - ${o.name}`;const b=document.createElement("button");b.className="unpin-btn",b.textContent="â€”",b.title="Unpin",b.onclick=async()=>{const h=(await se()).filter(w=>w!==o.symbol);await Se(h),await N()},f.append(v,b),m.appendChild(f);const g=document.createElement("p");if(g.className="pinned-price",o.price===void 0)g.textContent="N/A";else if(o.change===void 0)g.textContent=B(o.price);else{const h=o.percentChange!==void 0?`${o.percentChange>=0?"+":""}${o.percentChange.toFixed(2)}%`:"";g.innerHTML=`${B(o.price)} <span class="${o.change>=0?"positive":"negative"}">${o.change>=0?"+":""}${B(Math.abs(o.change))} (${h})</span>`}if(m.appendChild(g),o.canTrade){const h=document.createElement("div");h.className="buy-forms-inline";const w=document.createElement("form");w.className="trade-form-inline",w.innerHTML=`<input type="hidden" name="symbol" value="${o.symbol}"> <label>Shares:</label> <input type="number" name="shares" min="0.0001" step="0.0001" placeholder="Qty" required> <button type="submit" class="trade-button trade-button--buy">Buy</button>`,w.onsubmit=async I=>{I.preventDefault();const L=new FormData(w),C=parseFloat(String(L.get("shares")||"0"));await A(o.symbol,C,void 0)};const S=document.createElement("form");S.className="trade-form-inline",S.innerHTML=`<input type="hidden" name="symbol" value="${o.symbol}"> <label>Cash:</label> <input type="number" name="cash" min="0.01" step="0.01" placeholder="$" required> <button type="submit" class="trade-button trade-button--buy">Buy</button>`,S.onsubmit=async I=>{I.preventDefault();const L=new FormData(S),C=parseFloat(String(L.get("cash")||"0"));await A(o.symbol,void 0,C)};const E=document.createElement("form");E.className="trade-form-inline",E.innerHTML=`<input type="hidden" name="symbol" value="${o.symbol}"> <button type="submit" class="trade-button trade-button--buy">Buy Max</button>`,E.onsubmit=async I=>{I.preventDefault(),await A(o.symbol,void 0,(await r()).cash)},h.append(w,S,E),m.appendChild(h)}else if(o.showClosedNote){const h=document.createElement("p");h.className="market-closed-note",h.textContent="Stock market is closed on weekends. Use Skip Weekend to place trades.",m.appendChild(h)}if(o.holdingShares>0){const h=o.holdingShares;if(o.canTrade){const w=document.createElement("div");w.className="pinned-sell-actions trade-button-group";const S=document.createElement("button");S.className="trade-button trade-button--sell trade-button--wide",S.textContent="Sell",S.onclick=()=>ue(o.symbol,h);const E=document.createElement("form"),I=document.createElement("button");I.className="trade-button trade-button--sell trade-button--wide",I.textContent="Sell All",E.onsubmit=async L=>{L.preventDefault(),await le(o.symbol,h,void 0)},E.appendChild(I),w.append(S,E),m.appendChild(w)}else{const w=document.createElement("span");w.className="market-closed-inline",w.textContent="Market closed (weekend)",m.appendChild(w)}}p.appendChild(m),e.pinnedGrid.appendChild(p)}}}async function Je(t,a,d){if(e.portfolioSection.style.display=t.length?"":"none",!t.length)return Y(e.holdingsBody),0;const l=await Promise.all(t.map(o=>gt(o,a)));if(d!==T)return;const c=l.reduce((o,p)=>o+(p.price!==void 0?p.positionValue:0),0);Y(e.holdingsBody);for(const o of l){const p=document.createElement("tr"),m=document.createElement("td");if(o.price===void 0)m.textContent="-";else if(o.change===void 0)m.textContent=B(o.price);else{const w=o.percentChange!==void 0?`${o.percentChange>=0?"+":""}${o.percentChange.toFixed(2)}%`:"";m.innerHTML=`${B(o.price)} <span class="${o.change>=0?"positive":"negative"}">${o.change>=0?"+":""}${B(Math.abs(o.change))} (${w})</span>`}const f=o.price===void 0?"-":B(o.positionValue),v=o.price===void 0?"-":`<span class="${o.gain>=0?"positive":"negative"}">${Ne(o.gain)}</span>`,b=o.price===void 0||o.gainPercent===void 0?"":` (${o.gainPercent>=0?"+":""}${o.gainPercent.toFixed(2)}%)`,g=W(o.symbol)||!H(a),h=g?'<button class="trade-button trade-button--sell">Sell</button> <button class="trade-button trade-button--sell" style="margin-left:8px">Sell All</button>':'<span class="market-closed-inline">Market closed (weekend)</span>';if(p.innerHTML=`
        <td><strong>${o.symbol}</strong></td>
        <td>${je(o.shares)}</td>
        <td></td>
        <td>${B(o.avgCost)}</td>
        <td>${f}</td>
        <td>${v}${b}</td>
        <td>${h}</td>
      `,p.children[2].replaceWith(m),g){const w=p.querySelector("button"),S=p.querySelectorAll("button")[1];w&&(w.onclick=()=>ue(o.symbol,o.shares)),S&&(S.onclick=async()=>{await le(o.symbol,o.shares,void 0)})}e.holdingsBody.appendChild(p)}return c}async function Qe(){const t=await He(20);e.txSection.style.display=t.length?"":"none",Y(e.txBody);for(const a of t){const d=document.createElement("tr");d.innerHTML=`
        <td>${a.date} (${a.time})</td>
        <td><span class="${a.type==="BUY"?"buy-label":"sell-label"}">${a.type}</span></td>
        <td>${a.symbol}</td>
        <td>${je(a.shares)}</td>
        <td>${B(a.price)}</td>
        <td>${B(a.total)}</td>
        <td>${typeof a.profit_loss=="number"?`<span class="${a.profit_loss>=0?"positive":"negative"}">${Ne(a.profit_loss)}</span>`:"-"}</td>
      `,e.txBody.appendChild(d)}}function W(t){return t in Q}function Ce(t,a){const d=Q[t];return d?a>=d.invention:!0}async function Xe(t,a){const d=Object.keys(Q).filter(c=>Ce(c,t));if(e.cryptoSection.style.display=d.length?"":"none",!d.length){Y(e.cryptoGrid);return}const l=await Promise.all(d.map(c=>{const o=Q[c].name;return bt(c,o,t)}));if(a===T){Y(e.cryptoGrid);for(const c of l){const o=document.createElement("div");o.className="crypto-card";const p=document.createElement("div");p.className="stock-buy-details crypto-buy-details";const m=document.createElement("h3");m.textContent=`${c.name} (${c.symbol})`;const f=document.createElement("p");if(f.className="crypto-price",c.price===void 0)f.textContent="N/A";else if(c.change===void 0)f.textContent=B(c.price);else{const w=c.percentChange!==void 0?`${c.percentChange>=0?"+":""}${c.percentChange.toFixed(2)}%`:"";f.innerHTML=`${B(c.price)} <span class="${c.change>=0?"positive":"negative"}">${w}</span>`}const v=document.createElement("div");v.className="buy-forms-inline";const b=document.createElement("form");b.className="trade-form-inline",b.innerHTML=`<input type="hidden" name="symbol" value="${c.symbol}"> <label>Shares:</label> <input type="number" name="shares" min="0.0001" step="0.0001" placeholder="Qty" required> <button type="submit" class="trade-button trade-button--buy">Buy</button>`,b.onsubmit=async w=>{w.preventDefault();const S=new FormData(b),E=parseFloat(String(S.get("shares")||"0"));await A(c.symbol,E,void 0)};const g=document.createElement("form");g.className="trade-form-inline",g.innerHTML=`<input type="hidden" name="symbol" value="${c.symbol}"> <label>Cash:</label> <input type="number" name="cash" min="0.01" step="0.01" placeholder="$" required> <button type="submit" class="trade-button trade-button--buy">Buy</button>`,g.onsubmit=async w=>{w.preventDefault();const S=new FormData(g),E=parseFloat(String(S.get("cash")||"0"));await A(c.symbol,void 0,E)};const h=document.createElement("form");h.className="trade-form-inline",h.innerHTML=`<input type="hidden" name="symbol" value="${c.symbol}"> <button type="submit" class="trade-button trade-button--buy">Buy Max</button>`,h.onsubmit=async w=>{w.preventDefault(),await A(c.symbol,void 0,(await r()).cash)},v.append(b,g,h),p.append(m,f,v),o.appendChild(p),e.cryptoGrid.appendChild(o)}}}async function A(t,a,d){const l=await r(),c=l.currentDate,o=l.timeOfDay;if(!W(t)&&H(c)||W(t)&&!Ce(t,c))return;const p=await V(t,c);if(p===void 0)return;let m=a??(d?Math.floor(d/p/te)*te:0);if(!m||m<=0)return;const f=Math.round(m*p/ne)*ne;if(l.cash<f)return;const v=await n.get("holdings",t)||{shares:0,avgCost:0},b=v.shares+m,g=v.shares>0?(v.avgCost*v.shares+f)/b:p;await M({symbol:t,shares:b,avgCost:g}),l.cash=+(l.cash-f).toFixed(2),await u(l),await $({date:c,time:o,type:"BUY",symbol:t,shares:m,price:p,total:f}),await N()}async function le(t,a,d){const l=await r(),c=l.currentDate,o=l.timeOfDay;if(!W(t)&&H(c))return;const p=await V(t,c);if(p===void 0)return;const m=await n.get("holdings",t);if(!m||m.shares<=0)return;let f=a??(d?Math.floor(d/p/te)*te:0);if(f=Math.min(f,m.shares),!f||f<=0)return;const v=Math.round(f*p/ne)*ne,b=+(m.shares-f).toFixed(4),g=m.avgCost*f,h=+(v-g).toFixed(2);b<=0?await D(t):await M({symbol:t,shares:b,avgCost:m.avgCost}),l.cash=+(l.cash+v).toFixed(2),await u(l),await $({date:c,time:o,type:"SELL",symbol:t,shares:f,price:p,total:v,profit_loss:h}),await N()}async function ue(t,a){e.sellSymbol.textContent=t,e.sellSharesMax.max=String(a),e.sellForm.onsubmit=async d=>{d.preventDefault();const l=new FormData(e.sellForm),c=parseFloat(String(l.get("shares")||"0"))||void 0,o=parseFloat(String(l.get("cash")||"0"))||void 0;await le(t,c,o),e.sellModal.setAttribute("style","display:none")},e.sellModal.setAttribute("style","display:block")}window.showSellForm=ue,e.sellClose.onclick=()=>e.sellModal.setAttribute("style","display:none"),window.onclick=t=>{t.target===e.sellModal&&e.sellModal.setAttribute("style","display:none")};let F=[],O=-1;function ee(){e.suggestions.innerHTML="",e.suggestions.classList.remove("is-visible"),F=[],O=-1}function de(t){if(F=t.slice(0,50),!F.length){ee();return}e.suggestions.innerHTML=F.map((a,d)=>`<div class="autocomplete-item ${d===O?"is-active":""}" data-symbol="${a.symbol}"><span class="autocomplete-symbol">${a.symbol}</span><span class="autocomplete-name">${a.name}</span></div>`).join(""),e.suggestions.classList.add("is-visible")}function me(t){t&&(e.searchInput.value=t,ee(),xe(t))}e.searchInput.addEventListener("input",()=>{const t=e.searchInput.value.trim();if(t.length<2){ee();return}const a=t.toUpperCase(),d=Z.filter(l=>l.symbol.toUpperCase().startsWith(a)||l.name.toUpperCase().includes(a));de(d)}),e.suggestions.addEventListener("mousedown",t=>{const a=t.target.closest("[data-symbol]");a&&(t.preventDefault(),me(a.getAttribute("data-symbol")||""))});const Ee=document.getElementById("searchForm");Ee&&(Ee.onsubmit=t=>{t.preventDefault();const a=(e.searchInput.value||"").trim().toUpperCase();a&&me(a)}),e.searchInput.addEventListener("keydown",t=>{if(F.length)switch(t.key){case"ArrowDown":t.preventDefault(),O=(O+1)%F.length,de(F);break;case"ArrowUp":t.preventDefault(),O=(O-1+F.length)%F.length,de(F);break;case"Enter":O>=0&&F[O]&&(t.preventDefault(),me(F[O].symbol));break;case"Escape":ee();break}});async function xe(t){var p;const a=await r(),d=await V(t,a.currentDate),l=await oe(t,a.currentDate),c=((p=Z.find(m=>m.symbol===t))==null?void 0:p.name)||t;if(e.buySection.style.display="",e.buySection.innerHTML=`
      <div class="stock-buy-details">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>${t} - ${c}</h3>
          <button class="pin-btn" id="pinBtn">Pin Stock</button>
        </div>
        <p><strong>Current Price:</strong> ${d===void 0?"-":B(d)}
          ${l!==void 0&&d!==void 0?`<span class="${d-l>=0?"positive":"negative"}"> ${d-l>=0?"+":""}${B(Math.abs(d-l))} (${l&&(d-l)/l*100>=0?"+":""}${l?((d-l)/l*100).toFixed(2):""}%)</span>`:""}
        </p>
        ${!W(t)&&H(a.currentDate)?'<p class="market-closed-note">Stock market is closed on weekends. Use Skip Weekend to place trades.</p>':""}
        <div class="buy-forms-inline">
          <form id="buySharesForm" class="trade-form-inline">
            <label>Shares:</label>
            <input type="number" name="shares" min="0.0001" step="0.0001" placeholder="Qty" required>
            <button type="submit" class="trade-button trade-button--buy">Buy</button>
          </form>
          <form id="buyCashForm" class="trade-form-inline">
            <label>Cash:</label>
            <input type="number" name="cash" min="0.01" step="0.01" placeholder="$" required>
            <button type="submit" class="trade-button trade-button--buy">Buy</button>
          </form>
          <form id="buyMaxForm" class="trade-form-inline">
            <input type="hidden" name="cash" value="${a.cash}">
            <button type="submit" class="trade-button trade-button--buy">Buy Max</button>
          </form>
        </div>
      </div>
    `,!(W(t)||!H(a.currentDate)))for(const m of["buySharesForm","buyCashForm","buyMaxForm"]){const f=document.getElementById(m);f&&(f.style.display="none")}re=t,document.getElementById("pinBtn").onclick=async()=>{const m=await se();m.includes(t)||(m.push(t),await Se(m)),await N()},document.getElementById("buySharesForm").onsubmit=async m=>{m.preventDefault();const f=new FormData(m.currentTarget),v=parseFloat(String(f.get("shares")||"0"));await A(t,v,void 0)},document.getElementById("buyCashForm").onsubmit=async m=>{m.preventDefault();const f=new FormData(m.currentTarget),v=parseFloat(String(f.get("cash")||"0"));await A(t,void 0,v)},document.getElementById("buyMaxForm").onsubmit=async m=>{m.preventDefault(),await A(t,void 0,(await r()).cash)}}async function N(){const t=++T;try{const a=await r();if(t!==T)return;e.date.textContent=a.currentDate,e.day.textContent=ht(a.currentDate),e.time.textContent=a.timeOfDay[0].toUpperCase()+a.timeOfDay.slice(1),e.nextBtn.textContent=a.timeOfDay==="open"?"Jump to Market Close":"Next Day",e.cash.textContent=B(a.cash),e.pv.textContent=B(a.cash),i();const d=H(a.currentDate);e.skipWeekend.style.display=d?"":"none",e.weekendNote&&(e.weekendNote.style.display=d?"":"none"),We(a.currentDate);const[l,c]=await Promise.all([y(),se()]);if(await Promise.all(l.map(g=>X(g.symbol))),t!==T)return;const o=new Map(l.map(g=>[g.symbol,g]));if(await Ke(c,a.currentDate,o,t),t!==T)return;const p=await Je(l,a.currentDate,t);if(t!==T||p===void 0||(await Qe(),t!==T)||(await Xe(a.currentDate,t),t!==T)||e.buySection.style.display!=="none"&&re&&(await xe(re),t!==T))return;const m=a.cash+p;if(t!==T)return;e.pv.textContent=B(m);const f=await ft({date:a.currentDate,time:a.timeOfDay,value:m});if(t!==T)return;const v=await qe(f,a.currentDate,a.cash,l),b=Ve(v);if(t!==T)return;await Ze(b)}catch(a){console.error("refresh failed",a)}}e.resetBtn.onclick=async()=>{await n.clear("system"),await n.clear("holdings"),await n.clear("transactions"),R.clear(),G.clear(),await ke(),await N()},e.jumpWeek.onclick=async()=>{const t=await r();if(t.currentDate===k){s();return}const a=fe(t.currentDate,7);a===k&&a!==t.currentDate?s():i(),t.currentDate=a,t.timeOfDay="open",await u(t),await N()},e.jumpMonth.onclick=async()=>{const t=await r();if(t.currentDate===k){s();return}const a=Le(t.currentDate,1);a===k&&a!==t.currentDate?s():i(),t.currentDate=a,t.timeOfDay="open",await u(t),await N()},e.jumpYear.onclick=async()=>{const t=await r();if(t.currentDate===k){s();return}const a=Le(t.currentDate,12);a===k&&a!==t.currentDate?s():i(),t.currentDate=a,t.timeOfDay="open",await u(t),await N()},e.nextBtn.onclick=async()=>{const t=await r();if(t.currentDate===k&&t.timeOfDay==="close"){s();return}if(i(),t.timeOfDay==="open")t.timeOfDay="close";else{const a=fe(t.currentDate,1);a===k&&a!==t.currentDate&&s(),t.currentDate=a,t.timeOfDay="open"}await u(t),await N()},e.skipWeekend.onclick=async()=>{const t=await r();if(t.currentDate===k&&H(t.currentDate)){s();return}const d=q(t.currentDate).getUTCDay(),l=d===6?2:d===0?1:6-d,c=fe(t.currentDate,l);c===k&&c!==t.currentDate?s():i(),t.currentDate=c,t.timeOfDay="open",await u(t),await N()},e.jumpForm.onsubmit=async t=>{t.preventDefault();const a=+e.jumpYearSel.value,d=+e.jumpMonthSel.value,l=+e.jumpDaySel.value,o=new Date(Date.UTC(a,d-1,l)).toISOString().slice(0,10);let p=De(o);const m=await r();if(p<m.currentDate){e.jumpError.textContent="You can't travel backwards in time!",e.jumpError.style.display="block";return}p===k&&o>k?s():i(),m.currentDate=p,m.timeOfDay="open",await u(m),await N()},await N()}vt();
